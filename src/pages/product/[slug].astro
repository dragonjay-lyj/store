--- 
import MainLayout from '../../layouts/Layout.astro';
import ImageCarousel from '../../components/react/ImageCarousel.jsx';
import NSFWModal from '../../components/react/NSFWModal.jsx';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const products = await getCollection('products');
  return products.map(product => ({
    params: { slug: product.slug },
    props: { product },
  }));
}

const { product } = Astro.props;
const { Content } = await product.render();
const title = typeof product.data.title === 'string' ? product.data.title : product.data.title.zh;
const description = typeof product.data.description === 'string' ? product.data.description : product.data.description.zh;
const structuredData = {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": title,
  "image": product.data.coverImage,
  "description": description,
  "offers": {
    "@type": "Offer",
    "priceCurrency": "USD",
    "price": product.data.price
  }
};
export const prerender = true;
---
<MainLayout title={`${title} | 二次元商品贩卖网站`} description={description} image={product.data.coverImage}>
  <slot name="head">
    <script src="https://app.lemonsqueezy.com/js/lemon.js" defer></script>
  </slot>
  <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-purple-600">{title}</h1>
  <div class="flex flex-col md:flex-row gap-8">
    <div class="md:w-1/2">
      <ImageCarousel images={product.data.images || [product.data.coverImage]} client:visible />
    </div>
    <div class="md:w-1/2">
      <div class="flex gap-2 mb-4 flex-wrap">
        {product.data.tags.map(tag => <span class="bg-pink-200 text-pink-800 px-2 py-1 rounded text-sm">{tag}</span>)}
      </div>
      <p class="text-lg font-semibold text-pink-500 mb-4">￥{product.data.price}</p>
      <div class="flex items-center mb-4">
        {product.data.sellerAvatar && <img src={product.data.sellerAvatar} alt={product.data.sellerName} class="w-8 h-8 rounded-full mr-2" />}
        <span class="text-gray-600">卖家: {product.data.sellerName}</span>
      </div>
      <a class="lemonsqueezy-button bg-purple-500 text-white px-4 py-2 rounded inline-block mb-6" href={product.data.checkoutUrl} target="_blank" rel="noopener noreferrer" onerror="alert('支付系统暂时不可用，请稍后再试。')">
        立即购买
      </a>
      <div class="prose text-gray-700 text-sm sm:text-base">
        <Content />
      </div>
    </div>
  </div>
  <NSFWModal 
    isNSFW={product.data.isNSFW} 
    onClose={() => alert('NSFW 弹窗已关闭，可返回首页或继续浏览。')} 
    onAgeConfirmed={(confirmed) => alert(`年龄确认: ${confirmed ? '已满18岁' : '未满18岁'}`)} 
    client:visible
  />
  <slot name="structured-data">
    <script type="application/ld+json">
      {JSON.stringify(structuredData)}
    </script>
  </slot>
</MainLayout>